<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0c1830">
  <title>صرافی اسفندیاری | مینی‌اپ تلگرام</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    @font-face {
      font-family: "IRYekan";
      src: url("./fonts/IRANYekanXFaNum-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "IRYekan";
      src: url("./fonts/IRANYekanXFaNum-Bold.ttf") format("truetype");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --bg: #0c1830;
      --text: #e9eff8;
      --muted: #b2c4e4;
      --accent: #3cb7ff;
      --accent-strong: #2dd1a2;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "IRYekan", "Tahoma", sans-serif;
      background: linear-gradient(145deg, rgba(60, 183, 255, 0.18), rgba(45, 209, 162, 0.12)),
        radial-gradient(120% 80% at 20% 10%, rgba(255, 255, 255, 0.05), transparent),
        var(--bg);
      color: var(--text);
      padding: calc(18px + env(safe-area-inset-top)) 16px calc(22px + env(safe-area-inset-bottom));
      display: flex;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
    }

    .layout {
      width: min(520px, 100%);
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: center;
      transition: transform 0.2s ease;
      will-change: transform;
      position: relative;
      padding-bottom: 110px;
    }

    .is-hidden {
      display: none !important;
    }

    .layout.is-locked {
      display: none;
    }

    .logo-wrap {
      display: grid;
      place-items: center;
      width: 160px;
      height: 160px;
      margin: 4px 0 6px;
      position: relative;
      overflow: visible;
      transition: transform 0.35s ease, width 0.35s ease, height 0.35s ease;
    }

    .logo {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      overflow: visible;
      background: rgba(255, 255, 255, 0.06);
      display: grid;
      place-items: center;
      box-shadow: 0 16px 36px rgba(52, 189, 243, 0.162);
      position: relative;
      animation: floaty 12s ease-in-out infinite alternate;
    }

    .logo::before {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, var(--accent-strong), #030897, var(--accent-strong), var(--accent), #030897, var(--accent), #030897);
      mask: radial-gradient(farthest-side, transparent calc(100% - 5px), #000 calc(100% - 5px));
      -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 5px), #000 calc(100% - 5px));
      filter: blur(36px);
      animation: spin-border 0.6s linear infinite;
      z-index: 1;
      pointer-events: none;
    }

    #gate-screen .logo::before {
      animation:
        spin-border 0.6s linear infinite,
        pulse-red 0.6s ease-in-out infinite;
    }

    body.form-active {
      align-items: flex-start;
    }

    body.form-active .layout {
      padding-top: 4px;
      padding-bottom: 20px;
      gap: 0;
    }

    body.form-active .logo-wrap {
      width: 110px;
      height: 110px;
      transform: translateY(-4px) scale(0.9);
      margin-bottom: 0;
    }

    body.form-active .logo {
      width: 100%;
      height: 100%;
      box-shadow: 0 10px 22px rgba(52, 189, 243, 0.18);
    }

    .logo img {
      position: relative;
      z-index: 2;
      border-radius: 50%;
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .viewport {
      position: relative;
      overflow: hidden;
      border-radius: 18px;
      background: transparent;
      border: none;
      transition: opacity 0.35s ease, max-height 0.35s ease, transform 0.35s ease;
      max-height: 820px;
      opacity: 1;
      will-change: transform, opacity, max-height;
      touch-action: pan-y;
    }

    .viewport.is-hidden {
      opacity: 0;
      max-height: 0;
      height: 0;
      margin: 0;
      padding: 0;
      transform: translateY(-10px);
      pointer-events: none;
      position: absolute;
      left: 0;
      right: 0;
    }

    .track {
      display: flex;
      width: 100%;
      direction: ltr;
      transition: transform 0.35s cubic-bezier(0.22, 0.61, 0.36, 1);
      will-change: transform;
    }

    .slide {
      flex: 0 0 100%;
      min-width: 100%;
      direction: rtl;
      padding: 14px 14px 16px;
      display: grid;
      gap: 8px;
      min-height: auto;
      box-sizing: border-box;
      align-content: start;
    }

    .slide h2 {
      margin: 0 0 2px;
      font-size: 1.12rem;
      text-align: center;
      line-height: 1.2;
    }

    .slide p {
      margin: 0;
      color: var(--muted);
      line-height: 1.5;
      font-size: 0.93rem;
      text-align: center;
    }

    .cta {
      justify-self: center;
      padding: 14px 18px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #0c1729;
      font-weight: 700;
      font-size: 1rem;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 12px 26px rgba(42, 211, 139, 0.22);
      transition: transform 0.15s ease, box-shadow 0.2s ease;
      display: block;
      margin: 0px auto 6px;
      text-align: center;
      width: fit-content;
      position: relative;
      overflow: hidden;
    }

    .cta.is-hidden {
      opacity: 0;
      transform: translateY(-6px);
      pointer-events: none;
    }

    .cta:active {
      transform: translateY(1px);
      box-shadow: 0 10px 20px rgba(42, 211, 139, 0.2);
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      justify-content: center;
    }

    .dots {
      display: inline-flex;
      gap: 6px;
      margin-top: 6px;
    }

    .cta .progress {
      position: absolute;
      bottom: 0;
      right: 0;
      height: 3px;
      width: 100%;
      background: linear-gradient(90deg, rgba(0,166,228,0) 0%, rgba(0,166,228,0.9) 50%, rgba(3,8,151,0) 100%);
      transform: translateX(100%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .cta.is-progress .progress {
      opacity: 1;
      animation: sweep 3.6s linear infinite;
    }

    .cta.is-animating .progress {
      opacity: 0;
      animation: none;
    }

    .cta .premium-bar {
      position: absolute;
      top: -4px;
      bottom: -4px;
      left: -6px;
      width: 14px;
      background: linear-gradient(90deg, rgba(0,166,228,0) 0%, rgba(0,166,228,0.9) 50%, rgba(3,8,151,0) 100%);
      opacity: 0;
      filter: blur(1px);
      transform: translateX(-100%);
    }

    .cta.is-animating .premium-bar {
      opacity: 1;
      animation: sweep-badge 0.5s ease-out forwards;
    }

    @keyframes sweep {
      from { transform: translateX(100%); }
      to { transform: translateX(-100%); }
    }

    @keyframes sweep-badge {
      from { transform: translateX(-100%); opacity: 0.85; }
      to { transform: translateX(420%); opacity: 0; }
    }

    @keyframes floaty {
      0% { transform: translate3d(0, 0, 0) rotate(-1deg); box-shadow: 0 16px 36px rgba(52, 189, 243, 0.162);}
      25% { transform: translate3d(6px, -4px, 0) rotate(0deg); box-shadow: 0 16px 36px rgba(0, 4, 152, 0.25);}
      50% { transform: translate3d(-5px, 6px, 0) rotate(1deg); box-shadow: 0 16px 36px rgba(52, 189, 243, 0.162);}
      75% { transform: translate3d(4px, 3px, 0) rotate(-0.5deg); box-shadow: 0 16px 36px rgba(0, 165, 225, 0.25);}
      100% { transform: translate3d(-4px, -5px, 0) rotate(0deg); box-shadow: 0 16px 36px rgba(52, 189, 243, 0.162);}
    }

    @keyframes spin-border {
      to { transform: rotate(360deg); }
    }

    @keyframes pulse-red {
      0% {
        background: conic-gradient(from 0deg, var(--accent-strong), #030897, var(--accent-strong), var(--accent), #030897, var(--accent), #030897);
      }
      40% {
        background: conic-gradient(from 0deg, #ff9b9b, #7a0c0c, #ff9b9b, #ff6b6b, #7a0c0c, #ff6b6b, #7a0c0c);
      }
      100% {
        background: conic-gradient(from 0deg, var(--accent-strong), #030897, var(--accent-strong), var(--accent), #030897, var(--accent), #030897);
      }
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.18);
    }

    .dot.is-active {
      width: 18px;
      background: var(--accent);
      box-shadow: 0 6px 14px rgba(52, 190, 243, 0.3);
    }

    .note {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 24px;
      color: var(--muted);
      font-size: 0.88rem;
      line-height: 1.55;
      text-align: center;
      pointer-events: none;
      opacity:0.69;
    }

    .result {
      margin-top: 6px;
      text-align: center;
      color: var(--text);
      font-size: 0.95rem;
      min-height: 24px;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .result.is-error {
      color: #ff9b9b;
    }

    .form-panel {
      width: 100%;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 16px;
      padding: 14px 14px 16px;
      display: grid;
      gap: 12px;
      opacity: 0;
      max-height: 0;
      overflow: hidden;
      transform: translateY(8px);
      transition: opacity 0.3s ease, max-height 0.4s ease, transform 0.3s ease;
      direction: rtl;
      margin-top: -10px;
    }

    .form-panel.is-visible {
      opacity: 1;
      max-height: 1100px;
      transform: translateY(0);
      overflow: visible;
    }

    .field {
      display: grid;
      gap: 6px;
      opacity: 0;
      transform: translateY(10px);
    }

    .form-panel.is-visible .field {
      animation: fadeUp 0.35s ease forwards;
      animation-delay: calc(var(--idx, 0) * 80ms);
    }

    .input-box,
    .select-box {
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(12, 24, 48, 0.6);
      color: var(--text);
      border-radius: 12px;
      padding: 12px 14px;
      font-family: inherit;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .input-box:focus,
    .select-box:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(60, 183, 255, 0.18);
    }

    .phone-row {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: stretch;
    }

    .phone-btn {
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: linear-gradient(135deg, rgba(60, 183, 255, 0.16), rgba(45, 209, 162, 0.16));
      color: var(--text);
      border-radius: 12px;
      padding: 0 12px;
      font-family: inherit;
      font-size: 0.92rem;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      white-space: nowrap;
    }

    .phone-btn:active {
      transform: translateY(1px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.18);
    }

    .phone-btn[disabled] {
      opacity: 0.65;
      cursor: not-allowed;
      transform: none;
    }

    .checks {
      display: grid;
      gap: 10px;
    }

    .check {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: center;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .check span{
      font-size: 0.88rem;
    }

    .check:hover {
      border-color: rgba(255, 255, 255, 0.16);
    }

    .check input[type="checkbox"] {
      accent-color: var(--accent);
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .submit-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #0c1729;
      font-weight: 700;
      font-size: 1rem;
      font-family: inherit;
      cursor: pointer;
      box-shadow: 0 12px 26px rgba(42, 211, 139, 0.22);
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    .submit-btn:active {
      transform: translateY(1px);
      box-shadow: 0 10px 20px rgba(42, 211, 139, 0.2);
    }

    .submit-btn[disabled] {
      opacity: 0.55;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .link-button {
      background: none;
      border: none;
      color: var(--accent);
      text-decoration: underline dotted;
      font: inherit;
      cursor: pointer;
      padding: 0;
      text-decoration-line: underline;
      text-decoration-style: dotted;

    }

    .terms-modal {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      background: rgba(0, 0, 0, 0.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      padding: 18px;
      z-index: 20;
    }

    .terms-modal.is-visible {
      opacity: 1;
      pointer-events: all;
      display: grid;
    }

        .terms-card {
      width: min(640px, 100%);
      background: rgba(12, 24, 48, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
      display: grid;
      gap: 12px;
      max-height: 80vh;
      overflow: auto;
    }

    .terms-card header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      color: var(--text);
      font-weight: 700;
    }

    .terms-close {
      border: none;
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 10px;
      cursor: pointer;
      font: inherit;
    }

    .terms-text {
      width: 100%;
      min-height: 360px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      padding: 10px;
      font-family: "IRYekan", "Tahoma", sans-serif;
      font-size: 0.95rem;
      line-height: 1.6;
      resize: none;
      pointer-events: auto;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    .gate-card {
      width: 100%;
      background:none;
      border: none;

      padding: 16px 18px;
      display: grid;
      gap: 10px;
      text-align: center;
    }

    .gate-message{
    font-size: 0.88rem;
    }

    .gate-link {
      display: inline-block;
      padding: 12px 16px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #0c1729;
      text-decoration: none;
      font-weight: 700;
      box-shadow: 0 12px 26px rgba(42, 211, 139, 0.22);
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    
    @media (prefers-reduced-motion: reduce) {
      .track, .dot, .cta { transition: none; }
    }
  </style>
</head>
<body>
  <div class="layout is-locked" id="main-layout">
    <div class="logo-wrap">
      <div class="logo">
        <img src="./esf_modern.png" alt="لوگوی صرافی اسفندیاری">
      </div>
    </div>

    <section class="viewport" aria-label="ویژگی‌ها" role="group">
      <div class="track" data-track>
        <article class="slide" aria-label="تبدیل سریع">
          <h2>تبدیل فوری</h2>
          <p>خرید و فروش در بستری امن با فرآیند ساده، پشتیبانی ۲۴ ساعته و تسویه مطمئن</p>
        </article>
        <article class="slide" aria-label="کیف پول">
          <h2>کیف پول مطمئن</h2>
          <p>واریز و برداشت امن با کارت‌های بانکی عمان <br /> (بانک مسقط، ظفار، صحار و ...)</p>
        </article>
        <article class="slide" aria-label="بهترین نرخ">
          <h2>تضمین بهترین نرخ</h2>
          <p> نرخ لحظه‌ای بر اساس آخرین معاملات رسمی دلار تهران و بدون کارمزد پنهان</p>
          
        </article>
      </div>
    </section>

    <button class="cta" type="button" id="start-btn" aria-label="ثبت نام" style="justify-self:center; margin:0 auto 5px; display:block; text-align:center;">ثبت نام و <span id="cta-dynamic">خرید</span><span class="progress"></span><span class="premium-bar"></span></button>

        <div class="controls">

    </div>

    <div id="result" class="result" aria-live="polite"></div>

    <div class="form-panel" id="register-panel" aria-label="فرم ثبت نام" role="form">
      <div class="field" style="--idx:0">
        <input id="first-name" name="first_name" type="text" class="input-box" placeholder="نام" autocomplete="given-name" />
      </div>
      <div class="field" style="--idx:1">
        <input id="last-name" name="last_name" type="text" class="input-box" placeholder="نام خانوادگی" autocomplete="family-name" />
      </div>
      <div class="field" style="--idx:2">
        <div class="phone-row">
          <button type="button" class="phone-btn" id="phone-btn" aria-label="دریافت شماره از تلگرام">دریافت</button>
          <input id="phone-input" name="phone" type="tel" class="input-box" placeholder="شماره موبایل از تلگرام" inputmode="tel" readonly />
        </div>
      </div>
      <div class="field" style="--idx:3">
        <select id="country" name="country" class="select-box">
          <option value="" disabled selected>کشور محل سکونت</option>
          <option value="iran">ایران</option>
          <option value="oman">عمان</option>
          <option value="uae">امارات متحده عربی</option>
          <option value="bahrain">بحرین</option>
          <option value="kuwait">کویت</option>
          <option value="qatar">قطر</option>
          <option value="saudi_arabia">عربستان سعودی</option>
        </select>
      </div>
      <div class="field checks" style="--idx:4">
        <label class="check">
          <input type="checkbox" id="accept-terms" name="accept_terms" />
          <span>شرایط و <button type="button" class="link-button" id="open-terms">قوانین</button> را می‌پذیرم.</span>
        </label>
        <label class="check">
          <input type="checkbox" id="confirm-identity" name="confirm_identity" />
          <span>اطلاعات مطابق با مدارک هویتی من است.</span>
        </label>
      </div>
      <div class="field" style="--idx:5">
        <button type="button" class="submit-btn" id="register-submit" disabled>ثبت نام</button>
      </div>
    </div>

    <div class="terms-modal" id="terms-modal" role="dialog" aria-modal="true" aria-label="قوانین">
      <div class="terms-card">
        <header>
          <span>شرایط و قوانین استفاده</span>
          <button type="button" class="terms-close" id="close-terms">بستن</button>
        </header>
        <textarea class="terms-text" readonly>
۱. مقدمه و پذیرش شرایط

با ثبت‌نام، ورود یا استفاده از پلتفرم صرافی اسفندیاری، شما به‌عنوان «کاربر» تأیید می‌کنید که این شرایط و ضوابط را به‌طور کامل مطالعه کرده، درک نموده و بدون هیچ‌گونه قید و شرطی پذیرفته‌اید.
در صورت عدم موافقت با هر یک از مفاد این سند، استفاده از خدمات پلتفرم مجاز نخواهد بود.

۲. ماهیت و دامنه خدمات پلتفرم

پلتفرم صرافی اسفندیاری یک بستر تخصصی تبادل همتا‌به‌همتا (P2P) برای مبادله ریال عمان (OMR) و تومان ایران (IRT) است.

این پلتفرم صرافی رمزارزی نیست و هیچ‌گونه خدمات مرتبط با ارزهای دیجیتال ارائه نمی‌دهد.

پلتفرم صرفاً نقش واسط امن و امین (Escrow) را در نگهداری موقت ریال عمانی ایفا می‌کند.

کلیه پرداخت‌های مربوط به تومان ایران خارج از پلتفرم و مستقیماً بین حساب‌های بانکی کاربران انجام می‌شود.

۳. سطوح کاربری و احراز هویت

کاربران در پلتفرم در سه سطح تعریف می‌شوند:

سطح ۰: ثبت‌نام‌شده بدون تأیید ایمیل (صرفاً امکان مشاهده)

سطح ۱: ایمیل تأییدشده (بدون دسترسی به معامله یا کیف پول)

سطح ۲: کاربر کاملاً تأییدشده با احراز هویت (دسترسی کامل)

تکمیل فرآیند احراز هویت (KYC) شامل ارائه مدارک معتبر هویتی و اطلاعات بانکی الزامی است.

تأیید یا رد نهایی احراز هویت منحصراً در اختیار مدیریت پلتفرم صرافی اسفندیاری است.

۴. امنیت حساب و مسئولیت‌های کاربر

فعال‌سازی احراز هویت دو مرحله‌ای (2FA) برای ورود و برداشت الزامی است.

کاربر مسئول حفظ امنیت اطلاعات ورود، ایمیل و حساب‌های بانکی معرفی‌شده خود می‌باشد.

هرگونه فعالیت انجام‌شده از طریق حساب کاربری، به‌منزله اقدام آگاهانه و مجاز خود کاربر تلقی می‌گردد.

۵. کیف پول، واریز و برداشت

هر کاربر تأییدشده دارای یک کیف پول داخلی ریال عمان (OMR) است که شامل:

موجودی کل

موجودی قابل استفاده

موجودی مسدودشده در معاملات فعال

واریز OMR تنها از طریق حساب‌های رسمی معرفی‌شده پلتفرم و با بارگذاری رسید معتبر انجام می‌شود و نیازمند بررسی دستی است.

برداشت OMR فقط از موجودی قابل استفاده امکان‌پذیر بوده و پس از کسر کارمزد، به‌صورت دستی پردازش می‌شود.

۶. معاملات و آگهی‌ها

ایجاد آگهی خرید یا فروش OMR فقط برای کاربران سطح ۲ مجاز است.

با شروع هر معامله:

مبلغ OMR مربوطه به‌همراه کارمزد در حالت امانت (Escrow) مسدود می‌شود.

قیمت، کارمزد و شرایط معامله نهایی و غیرقابل تغییر خواهد بود.

هیچ معامله‌ای قابل لغو نیست و هر معامله فقط می‌تواند تکمیل، منقضی یا وارد فرآیند حل اختلاف شود.

۷. کارمزدها

کارمزد معاملات برابر با ۱٪ از ارزش OMR معامله است:

۰٫۵٪ از فروشنده

۰٫۵٪ از خریدار

کارمزد برداشت طبق تعرفه اعلام‌شده توسط پلتفرم محاسبه می‌شود.

کلیه کارمزدها پیش از تأیید نهایی، به‌صورت شفاف به کاربر نمایش داده می‌شوند.

پلتفرم صرافی اسفندیاری این حق را برای خود محفوظ می‌دارد که در صورت تغییر شرایط عملیاتی، بازار، هزینه‌ها یا الزامات قانونی، درصد و ساختار کارمزدها را در آینده اصلاح یا به‌روزرسانی نماید. هرگونه تغییر در کارمزدها پیش از اعمال، از طریق پلتفرم به کاربران اطلاع‌رسانی خواهد شد و ادامه استفاده از خدمات به‌منزله پذیرش شرایط جدید خواهد بود.

۸. حل اختلاف و داوری

در صورت بروز اختلاف، سیستم به‌صورت خودکار درخواست پشتیبانی ایجاد می‌کند.

هر دو طرف معامله موظف به ارائه مستندات معتبر هستند.

تصمیم مدیریت پلتفرم صرافی اسفندیاری قطعی، نهایی و لازم‌الاجرا است.

۹. تعلیق، مسدودسازی و خاتمه حساب

پلتفرم حق دارد در صورت نقض قوانین، ارائه اطلاعات نادرست، تقلب یا سوءاستفاده، حساب کاربر را به‌صورت موقت یا دائم مسدود نماید.

در مدت بررسی، وجوه مرتبط ممکن است مسدود باقی بمانند تا تعیین تکلیف نهایی انجام شود.

۱۰. محدودیت مسئولیت

پلتفرم صرافی اسفندیاری مسئول نوسانات نرخ ارز، تأخیرهای بانکی یا مشکلات پرداخت خارج از پلتفرم نیست.

صحت و انجام پرداخت‌های تومانی بر عهده کاربران طرف معامله می‌باشد.

مسئولیت پلتفرم صرفاً در چارچوب قوانین و فرآیندهای داخلی آن تعریف می‌شود.

۱۱. تغییر شرایط

پلتفرم صرافی اسفندیاری حق دارد در هر زمان این شرایط و ضوابط را اصلاح یا به‌روزرسانی کند.
ادامه استفاده از خدمات به‌منزله پذیرش نسخه جدید خواهد بود.        </textarea>
      </div>
    </div>

    </div>
  </div>

  <div class="layout" id="gate-screen" aria-label="دسترسی محدود">
    <div class="logo-wrap">
      <div class="logo">
        <img src="./esf_modern.png" alt="لوگو">
      </div>
    </div>
    <div class="gate-card">
      <h3 style="margin:0 0 6px;text-align:center;">صرافی اسفندیاری</h3>
      <p id="gate-message" class="gate-message" style="margin:0 0 12px;color:var(--muted);text-align:center;">برای استفاده از پلتفرم، لطفاً از داخل تلگرام وارد شوید.</p>
      <a class="gate-link" href="#" role="link">ورود به تلگرام</a>
    </div>
  </div>

<div class="note">
  © صرافی تضامنی اسفندیاری – شماره ثبت ۴۸۶۵۲۳


    </div>

  <script>
    const root = document.documentElement;
    const track = document.querySelector("[data-track]");
    const slides = Array.from(document.querySelectorAll(".slide"));
    const dots = Array.from(document.querySelectorAll(".dot"));
    const startBtn = document.getElementById("start-btn");
    const ctaDynamic = document.getElementById("cta-dynamic");
    const layout = document.getElementById("main-layout");
    const gateScreen = document.getElementById("gate-screen");
    const gateMessage = document.getElementById("gate-message");
    const gateLink = document.querySelector(".gate-link");
    const resultBox = document.getElementById("result");
    const formPanel = document.getElementById("register-panel");
    const phoneBtn = document.getElementById("phone-btn");
    const phoneInput = document.getElementById("phone-input");
    const registerSubmit = document.getElementById("register-submit");
    const acceptTerms = document.getElementById("accept-terms");
    const confirmIdentity = document.getElementById("confirm-identity");
    const openTermsBtn = document.getElementById("open-terms");
    const termsModal = document.getElementById("terms-modal");
    const closeTermsBtn = document.getElementById("close-terms");
    let index = 0;
    let pullStartY = 0;
    let pulling = false;
    let autoplay;
    let formMode = false;
    let isAuthorized = false;

    console.log("UI loaded");
    document.addEventListener("DOMContentLoaded", () => {
      if (Telegram?.WebApp) {
        Telegram.WebApp.disableVerticalSwipes();
      }
    });

    const showGate = (message) => {
      if (gateMessage && message) gateMessage.textContent = message;
      gateScreen?.classList.remove("is-hidden");
      layout?.classList.add("is-locked");
      isAuthorized = false;
    };

    const showApp = () => {
      gateScreen?.classList.add("is-hidden");
      layout?.classList.remove("is-locked");
      isAuthorized = true;
    };

    const checkTelegramAccess = async () => {
      const initData = window.Telegram?.WebApp?.initData || "";
      if (!initData) {
        showGate("برای استفاده از پلتفرم، لطفاً از داخل تلگرام وارد شوید.");
        return;
      }

      try {
        const res = await fetch("https://cf-init.esfex.workers.dev/api/auth/telegram", {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=UTF-8" },
          referrerPolicy: "no-referrer",
          body: JSON.stringify({ initData }),
        });
        if (!res.ok) {
          showGate("دسترسی ممکن نیست. لطفاً از داخل تلگرام وارد شوید.");
          return;
        }
        showApp();
      } catch (err) {
        console.error("Gate check error:", err);
        showGate("بررسی دسترسی ناموفق بود. لطفاً از داخل تلگرام دوباره تلاش کنید.");
      }
    };
    const setIndex = (i) => {
      index = ((i % slides.length) + slides.length) % slides.length;
      if (track) track.style.transform = `translate3d(-${index * 100}%, 0, 0)`;
      dots.forEach((dot, idx) => dot.classList.toggle("is-active", idx === index));
    };

    const startAutoplay = () => {
      clearInterval(autoplay);
      autoplay = setInterval(() => setIndex(index + 1), 4200);
    };

    startAutoplay();
    setIndex(0);

    checkTelegramAccess();

    const words = ["خرید", "فروش"];
    let wordIndex = 0;

    const swapWord = () => {
      if (!ctaDynamic) return;
      startBtn?.classList.add("is-animating");
      const current = words[wordIndex];
      const next = words[(wordIndex + 1) % words.length];
      const steps = [...current].length + [...next].length || 1;
      const stepTime = 500 / steps;

      [...current].forEach((_, i) => {
        setTimeout(() => {
          ctaDynamic.textContent = current.slice(0, current.length - (i + 1));
        }, stepTime * (i + 1));
      });

      [...next].forEach((_, i) => {
        setTimeout(() => {
          ctaDynamic.textContent = next.slice(0, i + 1);
          if (i === next.length - 1) wordIndex = (wordIndex + 1) % words.length;
        }, stepTime * (current.length + i + 1));
      });

      setTimeout(() => startBtn?.classList.remove("is-animating"), 600);
    };

    const pauseDuration = 3600;
    const typingDuration = 500;

    const runCycle = () => {
      startBtn?.classList.add("is-progress");
      setTimeout(() => {
        startBtn?.classList.remove("is-progress");
        swapWord();
        setTimeout(runCycle, typingDuration);
      }, pauseDuration);
    };

    runCycle();

    const onPullStart = (e) => {
      if (window.scrollY > 0) {
        pulling = false;
        return;
      }
      pulling = true;
      pullStartY = e.touches ? e.touches[0].clientY : e.clientY;
      layout.style.transition = "none";
    };

    const onPullMove = (e) => {
      if (!pulling) return;
      const y = e.touches ? e.touches[0].clientY : e.clientY;
      const delta = Math.max(0, y - pullStartY);
      if (delta > 0) {
        e.preventDefault();
        const offset = Math.min(delta * 0.4, 90);
        layout.style.transform = `translateY(${offset}px)`;
      }
    };

    const onPullEnd = () => {
      if (!pulling) return;
      layout.style.transition = "transform 0.2s ease";
      layout.style.transform = "translateY(0)";
      setTimeout(() => (layout.style.transition = "transform 0.2s ease"), 200);
      pulling = false;
    };

    window.addEventListener("touchstart", onPullStart, { passive: true });
    window.addEventListener("touchmove", onPullMove, { passive: false });
    window.addEventListener("touchend", onPullEnd, { passive: true });

    const setResult = (content, isError = false) => {
      if (!resultBox) return;
      resultBox.classList.toggle("is-error", isError);
      resultBox.textContent = content;
    };

    const showUser = (user) => {
      if (!resultBox) return;
      resultBox.classList.remove("is-error");
      const lines = [
        "id: " + (user?.id ?? "-"),
        "username: " + (user?.username ?? "-"),
        "first_name: " + (user?.first_name ?? "-"),
        "last_name: " + (user?.last_name ?? "-"),
      ];
      resultBox.textContent = lines.join("\n");
    };

    const verifyTelegramUser = async () => {
      const initData = window.Telegram?.WebApp?.initData || "";
      if (!initData) {
        setResult("initData not found. Please open this inside Telegram.", true);
        return;
      }

      setResult("Verifying...");

      try {
        const response = await fetch("https://cf-init.esfex.workers.dev/api/auth/telegram", {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=UTF-8" },
          referrerPolicy: "no-referrer",
          body: JSON.stringify({ initData }),
        });

        const payload = await response.json().catch(() => ({}));

        if (response.ok && payload?.ok && payload?.telegram_user) {
          showUser(payload.telegram_user);
        } else {
          const message =
            payload?.error ||
            payload?.message ||
            `Verification failed (status ${response.status})`;
          setResult(message, true);
        }
      } catch (err) {
        console.error("Telegram verification fetch error:", err);
        const msg = err && err.message ? `Network error: ${err.message}` : "Network or server error";
        setResult(msg, true);
      }
    };
    const enterFormMode = () => {
      if (!isAuthorized) {
        showGate("برای استفاده از پلتفرم، لطفاً از داخل تلگرام وارد شوید.");
        return;
      }
      if (formMode) return;
      formMode = true;
      clearInterval(autoplay);
      window.Telegram?.WebApp?.HapticFeedback?.impactOccurred("soft");
      window.Telegram?.WebApp?.MainButton?.hide();
      window.Telegram?.WebApp?.expand?.();
      document.body.classList.add("form-active");
      document.querySelector(".viewport")?.classList.add("is-hidden");
      startBtn?.remove();
      setTimeout(() => formPanel?.classList.add("is-visible"), 60);
      setResult("");
    };

    startBtn?.addEventListener("click", enterFormMode);

    const normalizePhone = (value) => (value || "").replace(/\s+/g, "");

    const validatePhone = (value) => {
      const v = normalizePhone(value);
      return /^[+]?\\d{8,15}$/.test(v);
    };

    const fetchPhoneFromBackend = async () => {
      const initData = window.Telegram?.WebApp?.initData || "";
      if (!initData) {
        setResult("initData یافت نشد. لطفاً از داخل تلگرام وارد شوید.", true);
        return null;
      }
      try {
        const res = await fetch("https://cf-init.esfex.workers.dev/api/profile", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ initData }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data?.error || data?.message || "شماره یافت نشد.";
          setResult(msg, true);
          return null;
        }
        if (data?.phone) {
          const normalized = normalizePhone(data.phone);
          phoneInput.value = normalized;
          setResult("شماره موبایل از سرور دریافت شد.");
          return normalized;
        }
        setResult("شماره‌ای ثبت نشده است.", true);
        return null;
      } catch (err) {
        console.error("fetch phone error:", err);
        setResult("خطای شبکه هنگام دریافت شماره.", true);
        return null;
      }
    };

    phoneBtn?.addEventListener("click", async () => {
  if (phoneBtn.disabled) return;

  try {
    phoneBtn.disabled = true;
    phoneBtn.textContent = "در حال درخواست...";

    if (!window.Telegram?.WebApp?.requestContact) {
      setResult("این قابلیت فقط داخل تلگرام فعال است.", true);
      return;
    }

    // ✅ Modern, correct API usage
    const res = await window.Telegram.WebApp.requestContact();

    // ❌ Only explicit cancel is failure
    if (res?.status !== "sent") {
      setResult("درخواست ارسال شماره لغو شد.", true);
      return;
    }

    // ✅ Success path
    setResult("شماره ارسال شد. در حال دریافت از سرور...");

    // ⏳ Poll backend (max 10s)
    const start = Date.now();
    const timeout = 10000;

    while (Date.now() - start < timeout) {
      const r = await fetch("/api/profile", { credentials: "include" });
      const data = await r.json();

      if (data?.phone) {
        phoneInput.value = data.phone;
        setResult("شماره موبایل با موفقیت دریافت شد");
        return;
      }

      await new Promise(r => setTimeout(r, 1000));
    }

    setResult("دریافت شماره بیش از حد طول کشید. لطفاً دوباره تلاش کنید.", true);

  } catch (err) {
    console.error("requestContact error:", err);
    setResult("درخواست ارسال شماره لغو شد.", true);
  } finally {
    phoneBtn.textContent = "دریافت";
    phoneBtn.disabled = false;
  }
});

    const submitRegistration = async () => {
      if (!isAuthorized) {
        showGate("برای استفاده از پلتفرم، لطفاً از داخل تلگرام وارد شوید.");
        return;
      }
      const firstName = document.getElementById("first-name")?.value?.trim() || "";
      const lastName = document.getElementById("last-name")?.value?.trim() || "";
      const phone = phoneInput?.value?.trim() || "";
      const country = document.getElementById("country")?.value || "";
      if (!firstName || !lastName || !phone || !country || !acceptTerms?.checked || !confirmIdentity?.checked) {
        window.Telegram?.WebApp?.HapticFeedback?.impactOccurred("warning");
        setResult("لطفاً همه فیلدها را تکمیل و تیک‌ها را فعال کنید.", true);
        return;
      }

      if (!validatePhone(phone)) {
        window.Telegram?.WebApp?.HapticFeedback?.impactOccurred("warning");
        setResult("شماره موبایل معتبر نیست.", true);
        return;
      }

      const initData = window.Telegram?.WebApp?.initData || "";
      if (!initData) {
        setResult("initData یافت نشد. لطفاً از داخل تلگرام باز کنید.", true);
        return;
      }

      const payload = {
        initData,
        first_name: firstName,
        last_name: lastName,
        phone,
        country,
        accept_terms: !!acceptTerms?.checked,
        confirm_identity: !!confirmIdentity?.checked,
      };

      const originalText = registerSubmit?.textContent;
      registerSubmit.disabled = true;
      registerSubmit.textContent = "در حال ارسال...";
      setResult("در حال ثبت نام...");

      try {
        const res = await fetch("https://cf-init.esfex.workers.dev/api/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const raw = await res.text();
        let data;
        try { data = JSON.parse(raw); } catch { data = raw; }

        if (!res.ok) {
          const msg = typeof data === "string" ? data : data?.error || data?.message || `خطا (${res.status})`;
          setResult(msg, true);
          window.Telegram?.WebApp?.HapticFeedback?.impactOccurred("warning");
          return;
        }

        setResult(typeof data === "string" ? data : JSON.stringify(data, null, 2));
        window.Telegram?.WebApp?.HapticFeedback?.impactOccurred("light");
      } catch (err) {
        console.error("Register error:", err);
        const msg = err?.message ? `خطای شبکه: ${err.message}` : "خطای شبکه";
        setResult(msg, true);
        window.Telegram?.WebApp?.HapticFeedback?.impactOccurred("warning");
      } finally {
        registerSubmit.disabled = false;
        if (originalText) registerSubmit.textContent = originalText;
      }
    };

    registerSubmit?.addEventListener("click", submitRegistration);

    const updateSubmitState = () => {
      const enabled = acceptTerms?.checked && confirmIdentity?.checked;
      if (!registerSubmit) return;
      registerSubmit.disabled = !enabled;
    };

    acceptTerms?.addEventListener("change", updateSubmitState);
    confirmIdentity?.addEventListener("change", updateSubmitState);
    updateSubmitState();

    const openTerms = () => {
      termsModal?.classList.add("is-visible");
    };

    const closeTerms = () => {
      termsModal?.classList.remove("is-visible");
    };

    openTermsBtn?.addEventListener("click", openTerms);
    closeTermsBtn?.addEventListener("click", closeTerms);
    termsModal?.addEventListener("click", (e) => {
      if (e.target === termsModal) closeTerms();
    });

    const applyTheme = () => {
      const params = window.Telegram?.WebApp?.themeParams || {};
      const normalize = (value) => {
        if (!value) return null;
        const v = String(value).trim();
        return v.startsWith("#") ? v : `#${v}`;
      };
      const bg = normalize(params.bg_color) || "#0f172a";
      root.style.setProperty("--bg", bg);
      root.style.setProperty("--text", normalize(params.text_color) || "#e9eff8");
      root.style.setProperty("--muted", normalize(params.hint_color) || "#b7c6dd");
      root.style.setProperty("--accent", normalize(params.button_color) || "#34bef3");
      root.style.setProperty("--accent-strong", normalize(params.button_text_color) || "#2bd18c");
      document
        .querySelector('meta[name="theme-color"]')
        .setAttribute("content", getComputedStyle(root).getPropertyValue("--bg").trim());
    };

    window.Telegram?.WebApp?.onEvent?.("themeChanged", applyTheme);
    applyTheme();
    window.Telegram?.WebApp?.setHeaderColor?.("secondary_bg_color");
    window.Telegram?.WebApp?.ready?.();
  </script>
</body>
</html>





