<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Telegram Auth Test</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{
      margin:0;
      background:#000;
      color:#00ff66;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding:16px;
    }
    .box{
      border:1px solid #00ff66;
      border-radius:12px;
      padding:14px;
      margin-top:12px;
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.5;
    }
    .dim{ opacity:.8; }
    .bad{ color:#ff4d4d; border-color:#ff4d4d; }
    button{
      margin-top:12px;
      background:#00ff66;
      color:#000;
      border:0;
      padding:10px 14px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
    }
    button:active{ transform: translateY(1px); }
  </style>
</head>
<body>
  <h2 style="margin:0 0 8px 0;">Telegram initData Verification</h2>
  <div class="dim">Open this page inside Telegram Mini App.</div>

  <button id="btn">Test /api/auth/telegram</button>

  <div id="status" class="box dim">Idle.</div>
  <div id="out" class="box" style="display:none;"></div>

  <script>
    // ✅ Replace this with your real Worker URL
    const WORKER_URL = "https://cf-init.esfex.workers.dev/api/auth/telegram";

    const statusEl = document.getElementById("status");
    const outEl = document.getElementById("out");
    const btn = document.getElementById("btn");

    function setStatus(text, isError=false){
      statusEl.textContent = text;
      statusEl.className = "box" + (isError ? " bad" : " dim");
    }

    function showOutput(text, isError=false){
      outEl.style.display = "block";
      outEl.textContent = text;
      outEl.className = "box" + (isError ? " bad" : "");
    }

    btn.addEventListener("click", async () => {
      outEl.style.display = "none";
      showOutput("", false);

      // Telegram object exists only inside Telegram WebView
      if (!window.Telegram || !Telegram.WebApp) {
        setStatus("ERROR: Telegram.WebApp not found. Open inside Telegram.", true);
        return;
      }

      const tg = Telegram.WebApp;
      tg.ready?.();

      // tg.initData is the signed raw string (what we verify)
      const initData = tg.initData || "";
      if (!initData) {
        setStatus("ERROR: tg.initData is empty. Are you inside Telegram Mini App?", true);
        return;
      }

      setStatus("Sending initData to Worker...");

      try {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ initData })
        });

        const text = await res.text();

        if (!res.ok) {
          setStatus(`FAILED (${res.status})`, true);
          showOutput(text, true);
          return;
        }

        setStatus("SUCCESS ✅ Verified by Worker");
        // Pretty-print JSON if possible
        try {
          const json = JSON.parse(text);
          showOutput(JSON.stringify(json, null, 2));
        } catch {
          showOutput(text);
        }
      } catch (e) {
        setStatus("ERROR: Network / CORS / wrong URL", true);
        showOutput(String(e), true);
      }
    });
  </script>
</body>
</html>
